{
  "version": 3,
  "sources": ["../index.js"],
  "sourcesContent": ["/**\n * RAG Plugin\n * Self-contained RAG (Retrieval-Augmented Generation) plugin\n *\n * Provides:\n * - Document ingestion and embedding\n * - Knowledge base querying\n * - Vector storage\n * - Admin UI integration\n *\n * Uses: Generic Hooks System\n */\n\n/**\n * Load method - called by pluginLoader with API\n * @param {Object} pluginAPI - { hookService, HOOKS, pluginLoader, registerView, registerClientComponent }\n */\nfunction load(pluginAPI) {\n  const { hookService, HOOKS, registerView, registerClientComponent } = pluginAPI;\n  const path = require('path');\n  const master = require('mastercontroller');\n\n  // Register this plugin directory as a component so MasterController can find controllers\n  // This allows the routes to resolve \"api/rag#method\" to this plugin's controllers\n  try {\n    console.log('  \u2713 Registering RAG plugin as MasterController component');\n    master.component(\"bb-plugins\", \"rag-plugin\");\n  } catch (error) {\n    console.error('  \u2717 Failed to register plugin as component:', error.message);\n  }\n\n  // Register admin views (WordPress-style)\n  try {\n    console.log('  \u2713 Registering RAG plugin admin views');\n    registerView('rag-settings', 'pages/admin/rag/settings/page', {\n      title: 'RAG Settings',\n      capability: 'manage_options',\n      icon: 'settings'\n    });\n    registerView('rag-documents', 'pages/admin/rag/documents/page', {\n      title: 'RAG Documents',\n      capability: 'manage_options',\n      icon: 'file'\n    });\n  } catch (error) {\n    console.error('  \u2717 Failed to register admin views:', error.message);\n  }\n\n  // Register client components\n  try {\n    console.log('  \u2713 Registering RAG plugin client components');\n    registerClientComponent('KnowledgeBaseSidebar', 'pages/client/KnowledgeBaseSidebar.js', {\n      description: 'Document management sidebar for chat interface',\n      usage: 'sidebar-left', // WordPress-style: register for left sidebar position\n      features: ['document-list', 'workspace-creation', 'document-upload', 'rag-settings']\n    });\n  } catch (error) {\n    console.error('  \u2717 Failed to register client components:', error.message);\n  }\n\n  // Register admin_menu hook for sidebar menu\n  hookService.addAction(HOOKS.ADMIN_MENU, async (context) => {\n    // Add top-level RAG menu\n    context.addMenuItem({\n      id: 'rag',\n      label: 'RAG',\n      url: '/bb-admin/plugin/rag-documents', // WordPress-style: /bb-admin/plugin/[slug]\n      icon: 'Database',\n      position: 30\n    });\n\n    // Add submenus\n    context.addSubmenuItem('rag', {\n      label: 'Documents',\n      url: '/bb-admin/plugin/rag-documents'\n    });\n\n    context.addSubmenuItem('rag', {\n      label: 'Settings',\n      url: '/bb-admin/plugin/rag-settings'\n    });\n  }, 10);\n\n  // Register routes by loading the routes file\n  // This happens during plugin load, which is after MasterController initialization\n  try {\n    const routesPath = path.join(__dirname, 'config', 'routes.js');\n    console.log('  \u2713 Loading RAG routes from plugin:', routesPath);\n    require(routesPath);\n    console.log('  \u2713 RAG routes registered successfully');\n  } catch (error) {\n    console.error('  \u2717 Failed to load RAG routes:', error.message);\n  }\n}\n\n/**\n * Activate method - called when plugin is first activated\n * WordPress equivalent: register_activation_hook()\n *\n * @param {Object} pluginAPI - { hookService, HOOKS, pluginLoader, pluginPath }\n */\nasync function activate(pluginAPI) {\n  const path = require('path');\n  const { exec } = require('child_process');\n  const { promisify } = require('util');\n  const execAsync = promisify(exec);\n  const fs = require('fs').promises;\n\n  console.log('\\n\uD83D\uDD0C Activating RAG Plugin...');\n\n  try {\n    // 1. Install npm dependencies\n    console.log('  \uD83D\uDCE6 Installing plugin dependencies...');\n    const pluginDir = path.join(__dirname);\n\n    // Check if package.json exists\n    const packageJsonPath = path.join(pluginDir, 'package.json');\n    try {\n      await fs.access(packageJsonPath);\n      console.log(`  \u2713 Found package.json at ${packageJsonPath}`);\n\n      // Run npm install in plugin directory\n      const { stdout, stderr } = await execAsync('npm install', {\n        cwd: pluginDir,\n        env: { ...process.env, NODE_ENV: 'production' }\n      });\n\n      if (stdout) console.log(`  \u2713 npm install output:\\n${stdout.split('\\n').map(l => '    ' + l).join('\\n')}`);\n      if (stderr && !stderr.includes('npm WARN')) {\n        console.warn(`  \u26A0 npm install warnings:\\n${stderr.split('\\n').map(l => '    ' + l).join('\\n')}`);\n      }\n\n      console.log('  \u2713 Plugin dependencies installed successfully');\n    } catch (err) {\n      if (err.code === 'ENOENT') {\n        console.log('  \u2139 No package.json found, skipping dependency installation');\n      } else {\n        throw err;\n      }\n    }\n\n    // 2. Run database migrations\n    console.log('  \uD83D\uDDC4\uFE0F  Running database migrations...');\n    try {\n      const master = require('mastercontroller');\n\n      // Check if migrations directory exists\n      const migrationsPath = path.join(pluginDir, 'app/models/db/migrations');\n      try {\n        await fs.access(migrationsPath);\n\n        // Run masterrecord migrations for this plugin\n        const { stdout: migrationOutput } = await execAsync(\n          `cd ${master.root} && masterrecord update-database rag`,\n          { env: process.env }\n        );\n\n        console.log('  \u2713 Database migrations completed');\n        if (migrationOutput) {\n          console.log(`${migrationOutput.split('\\n').map(l => '    ' + l).join('\\n')}`);\n        }\n      } catch (err) {\n        if (err.code === 'ENOENT') {\n          console.log('  \u2139 No migrations found, skipping');\n        } else {\n          throw err;\n        }\n      }\n    } catch (err) {\n      console.error('  \u2717 Migration error:', err.message);\n      throw err;\n    }\n\n    // 3. Create necessary directories\n    console.log('  \uD83D\uDCC1 Creating plugin directories...');\n    const master = require('mastercontroller');\n    const directories = [\n      path.join(master.root, 'storage/rag/documents'),\n      path.join(master.root, 'storage/rag/vectors')\n    ];\n\n    for (const dir of directories) {\n      try {\n        await fs.mkdir(dir, { recursive: true });\n        console.log(`  \u2713 Created directory: ${dir}`);\n      } catch (err) {\n        if (err.code !== 'EEXIST') throw err;\n      }\n    }\n\n    // 4. Fire PLUGIN_ACTIVATED hook\n    if (pluginAPI.hookService && pluginAPI.HOOKS) {\n      await pluginAPI.hookService.doAction(pluginAPI.HOOKS.PLUGIN_ACTIVATED, {\n        pluginName: 'rag-plugin',\n        pluginPath: pluginDir\n      });\n    }\n\n    console.log('\u2713 RAG Plugin activated successfully!\\n');\n\n    return {\n      success: true,\n      message: 'RAG Plugin activated successfully'\n    };\n\n  } catch (error) {\n    console.error('\u2717 RAG Plugin activation failed:', error.message);\n    console.error(error.stack);\n\n    return {\n      success: false,\n      error: error.message\n    };\n  }\n}\n\n/**\n * Deactivate method - called when plugin is deactivated\n * WordPress equivalent: register_deactivation_hook()\n *\n * @param {Object} pluginAPI - { hookService, HOOKS, pluginLoader, pluginPath }\n */\nasync function deactivate(pluginAPI) {\n  console.log('\\n\uD83D\uDD0C Deactivating RAG Plugin...');\n\n  try {\n    // Fire PLUGIN_DEACTIVATED hook\n    if (pluginAPI.hookService && pluginAPI.HOOKS) {\n      await pluginAPI.hookService.doAction(pluginAPI.HOOKS.PLUGIN_DEACTIVATED, {\n        pluginName: 'rag-plugin',\n        pluginPath: __dirname\n      });\n    }\n\n    console.log('\u2713 RAG Plugin deactivated successfully!\\n');\n\n    return {\n      success: true,\n      message: 'RAG Plugin deactivated successfully'\n    };\n\n  } catch (error) {\n    console.error('\u2717 RAG Plugin deactivation failed:', error.message);\n\n    return {\n      success: false,\n      error: error.message\n    };\n  }\n}\n\nmodule.exports = { load, activate, deactivate };\n"],
  "mappings": "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",
  "names": ["master"]
}
